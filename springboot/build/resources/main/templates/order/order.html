<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>WE READ UP - ì£¼ë¬¸</title>
    <link rel="icon" href="/img/read-up-logo.png" type="text/png">
    <link rel="stylesheet" href="/css/order/order.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body onload="totalProductPrice()">

<form action="/order" method="post" id="orderForm" class="container">
    <header class="top-header">
        <div class="top-inner">
            <div class="left">
                <a href="/" class="icon">&larr;</a>
            </div>
            <div class="center">
                <strong>ì‡¼í•‘ëª° í”„ë¡œì íŠ¸</strong>
            </div>
            <div class="right">
                <a href="/cart/list" class="icon">ğŸ›’</a>
                <a href="/myPage" class="icon">ğŸ‘¤</a>
            </div>
        </div>

        <!-- âœ… ê²€ì • íƒ­ë°”ë¥¼ header ë‚´ë¶€ë¡œ ì´ë™ -->
        <div class="tab-bar">
            ì£¼ë¬¸/ê²°ì œ
        </div>
    </header>

    <section class="delivery-section">

        <div class="form-container">
            <h3 class="section-title">ë°°ì†¡ì§€</h3>
            <div class="form-group">
                <label for="receipt">* ë°›ëŠ”ì‚¬ëŒ</label>
                <input type="text" id="receipt" name="deliveryDto.recipient" th:value="${orderPaymentRequest.addressDto != null ? orderPaymentRequest.addressDto.recipient : ''}">
            </div>
            <div class="form-group">
                <label for="zipCode">* ì£¼ì†Œ</label>
                <div class="address-group">
                    <input type="text" id="zipCode" name="deliveryDto.zipCode" th:value="${orderPaymentRequest.addressDto != null ? orderPaymentRequest.addressDto.zipCode : ''}" placeholder="ìš°í¸ë²ˆí˜¸">
                </div>
            </div>
            <div class="form-group">
                <label></label>
                <input type="text" id="main-address" name="deliveryDto.mainAddress" th:value="${orderPaymentRequest.addressDto != null ? orderPaymentRequest.addressDto.mainAddress : ''}" placeholder="ê¸°ë³¸ì£¼ì†Œ">
            </div>
            <div class="form-group">
                <label></label>
                <input type="text" id="detail-address" name="deliveryDto.detailAddress" th:value="${orderPaymentRequest.addressDto != null ? orderPaymentRequest.addressDto.detailAddress : ''}" placeholder="ë‚˜ë¨¸ì§€ ì£¼ì†Œ(ì„ íƒ ì…ë ¥ ê°€ëŠ¥)">
            </div>
            <div class="form-group">
                <label for="phoneNum">* íœ´ëŒ€ì „í™”</label>
                <input type="tel" id="phoneNum" name="deliveryDto.phoneNum" th:value="${orderPaymentRequest.addressDto != null ? orderPaymentRequest.addressDto.phoneNum : ''}" placeholder="'-'ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”." maxlength="13">
            </div>
            <div class="form-group">
                <select name="deliveryDto.message">
                    <option value="">-- ë©”ì‹œì§€ ì„ íƒ (ì„ íƒì‚¬í•­) --</option>
                    <option value="ë°°ì†¡ ì „ì— ë¯¸ë¦¬ ì—°ë½ë°”ëë‹ˆë‹¤.">ë°°ì†¡ ì „ì— ë¯¸ë¦¬ ì—°ë½ë°”ëë‹ˆë‹¤.</option>
                    <option value="ë¶€ì¬ ì‹œ ê²½ë¹„ì‹¤ì— ë§¡ê²¨ì£¼ì„¸ìš”.">ë¶€ì¬ ì‹œ ê²½ë¹„ì‹¤ì— ë§¡ê²¨ì£¼ì„¸ìš”.</option>
                    <option value="ë¶€ì¬ ì‹œ ë¬¸ ì•ì— ë†“ì•„ì£¼ì„¸ìš”.">ë¶€ì¬ ì‹œ ë¬¸ ì•ì— ë†“ì•„ì£¼ì„¸ìš”.</option>
                    <option value="ë¹ ë¥¸ ë°°ì†¡ ë¶€íƒë“œë¦½ë‹ˆë‹¤.">ë¹ ë¥¸ ë°°ì†¡ ë¶€íƒë“œë¦½ë‹ˆë‹¤.</option>
                    <option value="íƒë°°í•¨ì— ë³´ê´€í•´ ì£¼ì„¸ìš”.">íƒë°°í•¨ì— ë³´ê´€í•´ ì£¼ì„¸ìš”.</option>
                </select>
            </div>
        </div>

        <div class="form-container">

            <!-- ì£¼ë¬¸ ìƒí’ˆ ì˜ì—­ -->
            <h3 class="section-title">ì£¼ë¬¸ìƒí’ˆ</h3>

            <div class="product-box" th:each="orderBookRequest, stat : ${orderPaymentRequest.orderBookRequestList}">
                <img th:src="${orderBookRequest.image}" alt="ìƒí’ˆ ì´ë¯¸ì§€">
                <div class="product-info">
                    <div class="product-name" th:text="${orderBookRequest.name}">ìƒ˜í”Œìƒí’ˆ 2</div>
                    <div class="product-qty" th:text="|ìˆ˜ëŸ‰: ${orderBookRequest.quantity}ê°œ|">ìˆ˜ëŸ‰: 1ê°œ</div>
                    <div id="productPrice" class="product-price" th:text="|${#numbers.formatDecimal(orderBookRequest.orderPrice, 1, 'COMMA', 0, 'POINT')}ì›|">10,000ì›</div>
                </div>

                <input type="hidden" th:name="|orderBookDtoList[${stat.index}].bookId|" th:value="${orderBookRequest.bookId}">
                <input type="hidden" th:name="|orderBookDtoList[${stat.index}].quantity|" th:value="${orderBookRequest.quantity}">
                <input type="hidden" th:name="|orderBookDtoList[${stat.index}].price|" th:value="${orderBookRequest.orderPrice}">
                <input type="hidden" th:name="|orderBookDtoList[${stat.index}].cartId|" th:value="${orderBookRequest.cartId}">
            </div>

            <!-- ë°°ì†¡ë¹„ -->
            <div class="shipping-fee">
                <span>ë°°ì†¡ë¹„</span>
                <span class="price">0 ì›</span>
            </div>

        </div>

        <div class="form-container">

            <h3 class="section-title">í• ì¸/ë¶€ê°€ê²°ì œ</h3>

            <!-- ì ë¦½ê¸ˆ ì˜ì—­ -->
            <div class="row">
                <div class="label">ì ë¦½ê¸ˆ</div>
                <input type="text" name="paymentDto.mileageDiscount" placeholder="0" class="point-input" id="mileageInput">
                <button type="button" class="btn-small" onclick="useFullMileage()" data-available="5000" id="useAllBtn">ì „ì•¡ ì‚¬ìš©</button>
            </div>

            <div class="sub-info">ë³´ìœ  ì”ì•¡ <strong th:text="|${#numbers.formatDecimal(orderPaymentRequest.mileage, 1, 'COMMA', 0, 'POINT')}ì›|" id="availableMileage">5,000ì›</strong></div>

            <!-- ì ìš©ê¸ˆì•¡ -->
            <div class="total-apply">
                <span>ì ìš©ê¸ˆì•¡</span>
                <span class="price discount">-0ì›</span>
            </div>
        </div>

        <div class="form-container">
            <div class="summary-header">
                ê²°ì œì •ë³´
            </div>

            <div class="summary-item">
                <span>ì£¼ë¬¸ìƒí’ˆ</span>
                <span id="totalPrice" class="totalPrice">10,000ì›</span>
            </div>

            <div class="summary-item">
                <span>ë°°ì†¡ë¹„</span>
                <span class="price">+0ì›</span>
            </div>

            <div class="summary-item">
                <span>í• ì¸/ë¶€ê°€ê²°ì œ</span>
                <span class="price discount">-0ì›</span>
            </div>

            <div class="final-payment">
                <span>ìµœì¢… ê²°ì œ ê¸ˆì•¡</span>
                <span id="actualPrice" class="actualPrice">12,500ì›</span>
            </div>

            <input type="hidden" id="hiddenTotalPrice" name="paymentDto.totalPrice">
            <input type="hidden" id="hiddenActualPrice" name="paymentDto.actualPrice">
            <input type="hidden" name="orderDto.userId" th:value="${session.userId}">
        </div>

        <div class="form-container">
            <div class="method-header">
                <strong>ê²°ì œìˆ˜ë‹¨</strong>
            </div>
            <p class="method-subtitle">ê²°ì œìˆ˜ë‹¨ ì„ íƒ</p>

            <div class="payment-methods">
                <!-- ì‹ ìš©ì¹´ë“œ -->
                <label class="method-option selected">
                    <input type="radio" name="paymentDto.paymentMethod" value="ì‹ ìš©ì¹´ë“œ" checked hidden>
                    <span>ì‹ ìš©ì¹´ë“œ</span>
                </label>

                <!-- ìœ„ë¦¬í˜ì´ -->
                <label class="method-option">
                    <input type="radio" name="paymentDto.paymentMethod" value="ìœ„ë¦¬í˜ì´" hidden>
                    <span>ìœ„ë¦¬í˜ì´</span>
                </label>
            </div>
        </div>

        <div class="form-container">
            <div class="agreement-box">
                <p>êµ¬ë§¤ì¡°ê±´ í™•ì¸ ë° ê²°ì œì§„í–‰ ë™ì˜</p>
            </div>

            <div class="agreement-text">
                ì£¼ë¬¸ ë‚´ìš©ì„ í™•ì¸í•˜ì˜€ìœ¼ë©° ì•½ê´€ì— ë™ì˜í•©ë‹ˆë‹¤.
            </div>

            <button type="submit" class="submit-btn">
                <span id="paymentPrice">10,000ì›</span> ê²°ì œí•˜ê¸°
            </button>
            <input type="hidden" name="cartListResponse" id="cartListResponse"/>
        </div>

    </section>
</form>





<script>
    const availableMileage = parseInt(document.getElementById("availableMileage").textContent.replace(/,/g, "")) || 0;
    const mileageInput = document.getElementById("mileageInput");
    const button = document.getElementById("useAllBtn");
    const totalPrice = document.getElementById("totalPrice");
    const actualPrice = document.getElementById("actualPrice");
    const paymentPrice = document.getElementById("paymentPrice");

    mileageInput.addEventListener("change", updateDiscountPrice);
    button.addEventListener("click", updateDiscountPrice);

    // ë§ˆì¼ë¦¬ì§€ ì…ë ¥ ì‹œ ìµœì¢… ê²°ì œ ê¸ˆì•¡, í• ì¸ ê¸ˆì•¡ ë°˜ì˜
    function updateDiscountPrice() {
        const value = parseInt(mileageInput.value.replace(/,/g, "")) || 0;
        const total = parseInt(totalPrice.textContent.replace(/,/g, "").replace("ì›", "")) || 0;

        document.querySelectorAll(".price.discount").forEach(el => {
            el.textContent = "-" + value.toLocaleString() + "ì›";
        });
        actualPrice.textContent = (total - value).toLocaleString() + "ì›";
        paymentPrice.textContent = (total - value).toLocaleString() + "ì›";
    }

    // ì£¼ë¬¸ ì´ì•¡ ê³„ì‚°
    function totalProductPrice() {
        const productPrices = document.querySelectorAll("#productPrice");
        let total = 0;
        productPrices.forEach(p => {
            const price = parseInt(p.textContent.replace(/,/g, "")); // ì½¤ë§ˆ ì œê±° ì²˜ë¦¬
            if (!isNaN(price)) {
                total += price;
            }
        });
        totalPrice.textContent = total.toLocaleString() + "ì›";
        actualPrice.textContent = total.toLocaleString() + "ì›";
        paymentPrice.textContent = total.toLocaleString() + "ì›";
    }

    // ì „ì•¡ ì‚¬ìš© ë²„íŠ¼ í´ë¦­ ì‹œ
    document.getElementById('useAllBtn').addEventListener('click', function (event) {
        event.preventDefault();
        // ê°€ê²©ê³¼ ë§ˆì¼ë¦¬ì§€ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
        let totalPrice = parseInt(document.getElementById('totalPrice').textContent.replace(/,/g, '').replace(/ì›/g, ''));
        let availableMileage = parseInt(document.getElementById('availableMileage').textContent.replace(/,/g, '').replace(/ì›/g, ''));

        console.log('í† íƒˆ ' + totalPrice);
        console.log('ë§ˆì¼ë¦¬ì§€ ' + availableMileage);

        // ë§ˆì¼ë¦¬ì§€ ì…ë ¥ ê°’ ì„¤ì •: totalPrice ë³´ë‹¤ í° ë§ˆì¼ë¦¬ì§€ëŠ” totalPriceë§Œí¼ ì‚¬ìš©
        let usableMileage = availableMileage > totalPrice ? totalPrice : availableMileage;
        // mileageInputì˜ value ì†ì„±ì— ì„¤ì •
        mileageInput.value = formatNumber(usableMileage);
        updateDiscountPrice(); // ë§ˆì¼ë¦¬ì§€ ë³€ê²½ í›„ í• ì¸ ê¸ˆì•¡ ì—…ë°ì´íŠ¸
    });

    // ìˆ«ì â†’ ì½¤ë§ˆ ì¶”ê°€ëœ ë¬¸ìì—´ë¡œ í¬ë§·
    function formatNumber(num) {
        return Number(num).toLocaleString(); // 5000 â†’ "5,000"
    }

    // ì´ˆê³¼ ì œí•œ
    mileageInput.addEventListener('input', function () {
        let raw = Number(this.value.replaceAll(",", ""));

        if (isNaN(raw)) {
            this.value = "";
            return;
        }

        // ì…ë ¥ëœ ë§ˆì¼ë¦¬ì§€ê°€ availableMileageë¥¼ ì´ˆê³¼í•˜ë©´ availableMileageë¡œ ì„¤ì •
        if (raw > availableMileage) {
            raw = availableMileage;
        }

        // ì…ë ¥ëœ ê°’ì„ ì½¤ë§ˆ í˜•ì‹ìœ¼ë¡œ í¬ë§·í•˜ì—¬ ì„¤ì •
        this.value = formatNumber(raw);
        updateDiscountPrice(); // ë§ˆì¼ë¦¬ì§€ ë³€ê²½ í›„ í• ì¸ ê¸ˆì•¡ ì—…ë°ì´íŠ¸
    });

    // form ì œì¶œ ì „ mileageDiscount ê°’ ìˆ«ìë¡œ ë³€ê²½
    document.querySelector("form").addEventListener("submit", function () {
        const mileageRaw = mileageInput.value.replace(/,/g, "").trim();
        mileageInput.value = mileageRaw === "" ? 0 : mileageRaw;
    });

    // totalPrice, actualPrice input[type=hidden]ì— ë„£ê¸°
    document.querySelector("form").addEventListener("submit", function () {
        // ì‹¤ì œ ê¸ˆì•¡ ë¬¸ìì—´ì—ì„œ ì½¤ë§ˆ, "ì›" ì œê±°
        const actual = document.getElementById("actualPrice").textContent.replace(/[,ì›\s]/g, "");
        const total = document.getElementById("totalPrice").textContent.replace(/[,ì›\s]/g, "");

        // hidden inputì— ê°’ ì„¤ì •
        document.getElementById("hiddenActualPrice").value = actual;
        document.getElementById("hiddenTotalPrice").value = total;
    });

    // ì‹ ìš©ì¹´ë“œì™€ ìœ„ë¦¬í˜ì´ í´ë¦­ ì‹œ ë³€ê²½
    document.querySelectorAll("input[name='paymentDto.paymentMethod']").forEach(radio => {
        radio.addEventListener("change", function () {
            // ëª¨ë“  ë¼ë²¨ì—ì„œ selected ì œê±°
            document.querySelectorAll(".method-option").forEach(label => {
                label.classList.remove("selected");
            });

            // í˜„ì¬ ë¼ë””ì˜¤ì˜ ë¶€ëª¨ labelì— selected ì¶”ê°€
            this.closest("label").classList.add("selected");
        });
    });

    // submit ë²„íŠ¼ í´ë¦­ ì‹œ alert ë°œìƒ
    document.getElementById("orderForm").addEventListener("submit", function (event) {
        event.preventDefault();
        let receipt = $('#receipt').val();
        let zipCode = $('#zipCode').val();
        let mainAddress = $('#main-address').val();
        let detailAddress = $('#detail-address').val();
        let phoneNum = $('#phoneNum').val();
        console.log('receipt' + receipt);
        console.log('zipCode' + zipCode);
        console.log('mainAddress' + mainAddress);
        console.log('detailAddress' + detailAddress);
        console.log('phoneNum' + phoneNum);
        if (receipt && zipCode && mainAddress && detailAddress && phoneNum) {
            alert("ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            $('#orderForm').attr('action', '/order')
            $('#orderForm').attr('method', 'post')
            $('#orderForm').submit();
        } else {
            alert("ë°°ì†¡ì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            $('#receipt').focus();
        }
    });

    $('#zipCode').on('input', function () {
        let zip = $('#zipCode').val().replace(/[^0-9-]/g, '');
        $(this).val(zip);
    });

    $('#phoneNum').on('input', function () {
        let phoneNum = $('#phoneNum').val().replace(/[^0-9-]/g, '');
        $(this).val(phoneNum);
    });

</script>


</body>
</html>